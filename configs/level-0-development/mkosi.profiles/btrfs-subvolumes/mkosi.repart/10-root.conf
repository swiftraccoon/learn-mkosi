# Root Partition with Btrfs Subvolumes
#
# Creates a single 30GB btrfs partition with multiple subvolumes that are
# separately mounted at boot. This provides:
# - Snapshot isolation between system areas
# - Shared free space across all subvolumes
# - Compression and deduplication across the entire filesystem
#
# Requirements:
# - systemd-repart >= 256 (for MountPoint= directive)
# - btrfs-progs >= 6.12 (for offline subvolume creation)
# - Directories must exist in /buildroot (created by mkosi.finalize)
#
# How it works:
# 1. mkosi.finalize creates the directory structure
# 2. systemd-repart calls mkfs.btrfs with --rootdir=/buildroot
# 3. mkfs.btrfs creates subvolumes from the Subvolumes= list
# 4. systemd-repart generates /etc/fstab from MountPoint= directives
# 5. At boot, each subvolume mounts to its designated path

[Partition]
Type=root
Label=root
Format=btrfs

# Copy the built rootfs into the filesystem
CopyFiles=/
SizeMinBytes=30G
Weight=1000

# Create subvolumes at mkfs time
# EVERY PATH HERE must exist in /buildroot when mkfs.btrfs runs
# These directories are created by mkosi.finalize.btrfs-subvolumes
#
# Subvolumes are organized for security isolation per CIS recommendations:
# - Separate subvolumes for directories that may fill up (logs, tmp)
# - Separate subvolumes for user-writable areas (home)
# - Separate subvolumes for security-sensitive logs (audit)
Subvolumes=/home
Subvolumes=/srv
Subvolumes=/var
Subvolumes=/var/log
Subvolumes=/var/log/audit
Subvolumes=/var/tmp
Subvolumes=/var/spool
Subvolumes=/var/cache
Subvolumes=/var/crash
Subvolumes=/var/lib
Subvolumes=/var/lib/machines
Subvolumes=/var/lib/portables
Subvolumes=/var/lib/libvirt
Subvolumes=/tmp
Subvolumes=/opt
Subvolumes=/root

# MountPoint directives - systemd-repart will generate /etc/fstab from these
# Root mount (first) gets the filesystem-wide options
# Btrfs mount options are filesystem-wide - only the first mount's options take effect
# Subvolume mounts only need the subvol= option
#
# Note: Modern kernels (6.2+) handle async discard automatically, no need for explicit discard
# For Level 0 (dev), we're not adding restrictive mount options yet
# Level 1+ will add nosuid,nodev,noexec where appropriate
MountPoint=/:compress=zstd,noatime
MountPoint=/home:subvol=/home
MountPoint=/root:subvol=/root
MountPoint=/srv:subvol=/srv
MountPoint=/var:subvol=/var
MountPoint=/var/lib:subvol=/var/lib
MountPoint=/var/lib/machines:subvol=/var/lib/machines
MountPoint=/var/lib/portables:subvol=/var/lib/portables
MountPoint=/var/lib/libvirt:subvol=/var/lib/libvirt
MountPoint=/var/log:subvol=/var/log
MountPoint=/var/log/audit:subvol=/var/log/audit
MountPoint=/var/tmp:subvol=/var/tmp
MountPoint=/var/spool:subvol=/var/spool
MountPoint=/var/cache:subvol=/var/cache
MountPoint=/var/crash:subvol=/var/crash
MountPoint=/tmp:subvol=/tmp
MountPoint=/opt:subvol=/opt