# Level 0: Development/Learning
# Target: Local development, learning mkosi, experimentation
# Security: Basic protections, prioritizes convenience over security
# WARNING: NOT suitable for production use
#
# This is the base configuration for Level 0. OS-specific settings are
# configured in mkosi.conf.d/ drop-in files using [Match] sections.

[Config]
MinimumVersion=25

# Distribution and Release are set in mkosi.conf.d/ drop-ins
# based on the OS being built (f42, rhel9, centos10, etc.)

[Output]
Format=disk
OutputDirectory=mkosi.output
# ImageId is set in mkosi.conf.d/ drop-ins
ImageVersion=1.0
CompressOutput=zstd

[Content]
# Minimal package set for functional system
Packages=
    # Kernel & Core System
    kernel
    systemd
    systemd-udev
    dbus
    dbus-broker

    # Base Utilities
    coreutils
    util-linux
    bash
    grep
    sed
    gawk
    findutils
    which
    procps-ng
    psmisc
    shadow-utils
    sudo
    less
    tar
    gzip
    bzip2
    xz

    # Filesystem
    filesystem
    e2fsprogs
    dosfstools
    # btrfs-progs is added via Fedora-specific config (not available in RHEL/CentOS)

    # Networking
    NetworkManager
    iproute
    iputils
    hostname

    # Security Baseline
    selinux-policy-targeted
    policycoreutils
    firewalld
    cracklib-dicts
    cryptsetup
    audit                # Basic security logging
    aide                 # File integrity monitoring

    # CPU Microcode Updates
    microcode_ctl

    # Kernel Modules (for network filesystems & crypto)
    kernel-modules-extra

    # Package Management
    dnf
    rpm

    # Text Editor
    vim-minimal

    # Time & SSL
    tzdata
    ca-certificates
    chrony

    # Bootloader
    systemd-boot-unsigned

# Build-time only packages
BuildPackages=
    systemd-rpm-macros

# Minimize image size
WithDocs=no
WithRecommends=no
CleanPackageMetadata=auto

# SELinux configuration
# Disable offline relabel to avoid PCRE version mismatch during build
# Level 0 uses enforcing=0 (permissive mode) to allow first boot to complete
# The system will perform proper relabeling via .autorelabel flag
# Level 1+ will use enforcing=1 for production security
SELinuxRelabel=no

# First boot configuration (systemd-firstboot)
# These settings prevent interactive prompts on first boot
Locale=C.UTF-8
LocaleMessages=C.UTF-8
Timezone=UTC
# Hostname is set in mkosi.conf.d/ drop-ins

# Root Password: Development Convenience
# Level 0 is for LOCAL DEVELOPMENT ONLY - prioritizes convenience
#
# Passwordless root for easy access during development:
RootPassword=hashed:
#
# This creates an unlocked root account with NO password required.
# You can log in by just pressing Enter at the login prompt.
#
# WARNING: NEVER use this in production or network-accessible systems!
#
# For slightly better security during development, set a simple password:
#   RootPassword=dev
#
# For production use, see Level 1 configuration.

# Bootloader configuration
Bootable=yes
Bootloader=systemd-boot
UnifiedKernelImages=unsigned

# Kernel command line embedded in UKI
# Enhanced with security parameters and debugging options
# Level 0: SELinux in permissive mode for development (enforcing=0)
KernelCommandLine=rw console=hvc0 selinux=1 enforcing=0 security=selinux audit=1 init_on_alloc=1 init_on_free=1 page_alloc.shuffle=1 systemd.log_level=info rd.systemd.show_status=auto

# Post-installation script
PostInstallationScripts=mkosi.postinst

[Build]
# Enable btrfs subvolumes for faster builds (only works if host filesystem is btrfs)
# Currently disabled as build host uses ext4
# UseSubvolumes=yes

[Runtime]
# Runtime configuration for testing with QEMU
Firmware=uefi
RAM=2G
CPUs=2
# Use hvc0 for virtio console (not ttyS0 for legacy serial)
KernelCommandLineExtra=console=hvc0
