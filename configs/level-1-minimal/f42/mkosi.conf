# Level 1: Baseline Hardening (Production-Ready)
# Target: General production servers, standard deployments
# Security: CIS Benchmark Level 1 - Server aligned, production baseline

[Config]
MinimumVersion=26

[Distribution]
Distribution=fedora
Release=42

[Output]
Format=disk
OutputDirectory=mkosi.output
ImageId=fedora-minimal-level1
ImageVersion=1.0
CompressOutput=zstd
# Fixed seed for reproducible partition UUIDs across builds
Seed=a3c4e8f0-1234-5678-9abc-def012345678

[Content]
# Minimal package set for functional system
Packages=
    # Kernel & Core System
    kernel
    systemd
    systemd-udev
    dbus
    dbus-broker

    # Base Utilities
    coreutils
    util-linux
    bash
    grep
    sed
    gawk
    findutils
    which
    procps-ng
    psmisc
    shadow-utils
    sudo
    less
    tar
    gzip
    bzip2
    xz

    # Filesystem
    filesystem
    e2fsprogs
    dosfstools

    # Networking
    NetworkManager
    iproute
    iputils
    hostname

    # Security Baseline
    selinux-policy-targeted
    policycoreutils
    firewalld
    cracklib-dicts
    cryptsetup

    # CPU Microcode Updates (security-critical firmware)
    microcode_ctl

    # Kernel Modules (for network filesystems & crypto)
    kernel-modules-extra

    # Package Management & Updates
    dnf
    rpm
    dnf-automatic

    # Text Editor
    vim-minimal

    # Time & SSL
    tzdata
    ca-certificates
    chrony

    # Remote Administration (Production Requirement)
    openssh-server
    openssh-clients

    # Audit & Logging (CIS Level 1 Requirement)
    audit
    rsyslog

    # System Accounting (Production Baseline)
    psacct

    # File Integrity Monitoring
    aide

    # Password Quality
    passwdqc
    libpwquality

    # Bootloader
    systemd-boot-unsigned

# Build-time only packages
BuildPackages=
    systemd-rpm-macros

# Minimize image size
WithDocs=no
WithRecommends=no
CleanPackageMetadata=auto

# SELinux configuration
SELinuxRelabel=yes

# First boot configuration (systemd-firstboot)
# These settings prevent interactive prompts on first boot
Locale=C.UTF-8
LocaleMessages=C.UTF-8
Timezone=UTC
Hostname=fedora-level1

# Root Password: Production Security
# Level 1 is production-ready and requires proper authentication.
#
# For production deployments, you MUST set a strong password:
#   Option 1: Plaintext (will be hashed at build time)
#     RootPassword=YourStrongPassword123!
#
#   Option 2: Pre-hashed (use 'openssl passwd -6' to generate)
#     RootPassword=hashed:$6$rounds=656000$...
#
# For SSH key-only authentication (recommended):
#   1. Leave RootPassword unset or use: RootPassword=!
#   2. Add SSH authorized_keys via mkosi.extra/root/.ssh/authorized_keys
#   3. Configure SSH to disable password authentication (done in postinst)
#
# For development/testing ONLY, you may use:
#   RootPassword=test    # WARNING: Insecure, do not use in production
#
# Default: Locked root account - requires SSH key authentication
RootPassword=!

# Bootloader configuration
Bootable=yes
Bootloader=systemd-boot
UnifiedKernelImages=unsigned

# Kernel command line embedded in UKI
# Level 1: SELinux enforcing, audit enabled, memory hardening
KernelCommandLine=rw console=hvc0 selinux=1 enforcing=1 security=selinux audit=1 init_on_alloc=1 init_on_free=1 page_alloc.shuffle=1

# Post-installation script
PostInstallationScripts=mkosi.postinst

[Runtime]
# Runtime configuration for testing with QEMU
Firmware=uefi
RAM=2G
CPUs=2
# Use hvc0 for virtio console (not ttyS0 for legacy serial)
KernelCommandLineExtra=console=hvc0
